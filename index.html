<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volatility Stocks - Real Market Simulation</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2962ff;
            --secondary: #0039cb;
            --success: #00c853;
            --danger: #ff1744;
            --warning: #ffab00;
            --background: #121826;
            --card-bg: #1f2937;
            --text: #e5e7eb;
            --text-secondary: #9ca3af;
            --border: #374151;
            --crash: #ff5252;
            --rally: #69f0ae;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px 0;
            text-align: center;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            position: relative;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        .stats {
            display: flex;
            justify-content: space-between;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .positive {
            color: var(--success);
        }

        .negative {
            color: var(--danger);
        }

        .crash {
            color: var(--crash);
            animation: flash 0.5s infinite;
        }

        .rally {
            color: var(--rally);
            animation: pulse 0.5s infinite;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .game-area {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .stocks-list {
            overflow-y: auto;
            max-height: 500px;
        }

        .stock-item {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr 1fr 1fr;
            gap: 10px;
            padding: 15px;
            border-bottom: 1px solid var(--border);
            align-items: center;
            transition: all 0.3s;
        }

        .stock-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .stock-header {
            font-weight: bold;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            position: sticky;
            top: 0;
        }

        .stock-symbol {
            font-weight: bold;
        }

        .stock-price {
            font-weight: bold;
        }

        .stock-change {
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        button {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-buy {
            background-color: var(--success);
            color: white;
        }

        .btn-sell {
            background-color: var(--danger);
            color: white;
        }

        .btn-info {
            background-color: var(--primary);
            color: white;
        }

        .portfolio {
            margin-top: 20px;
        }

        .portfolio-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .news-item {
            margin-bottom: 15px;
            padding: 10px;
            border-left: 3px solid var(--primary);
            background-color: rgba(41, 98, 255, 0.1);
        }

        .news-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .tip {
            background-color: rgba(255, 171, 0, 0.1);
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid var(--warning);
        }

        .tip h3 {
            margin-bottom: 8px;
            color: var(--warning);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 10px;
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid var(--border);
            border-radius: 5px;
            background-color: var(--background);
            color: var(--text);
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom: 3px solid var(--primary);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            height: 300px;
            margin: 20px 0;
            position: relative;
        }

        .market-indicators {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .indicator {
            text-align: center;
        }

        .progress-bar {
            height: 6px;
            background-color: var(--border);
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            border-radius: 3px;
        }

        .progress.positive {
            background-color: var(--success);
        }

        .progress.negative {
            background-color: var(--danger);
        }

        .time-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .time-btn {
            flex: 1;
            padding: 10px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .time-btn.active {
            background-color: var(--secondary);
        }

        .risk-warning {
            background-color: rgba(255, 23, 68, 0.1);
            border-left: 3px solid var(--danger);
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .event-banner {
            padding: 10px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 5px;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        .event-bear {
            background-color: rgba(255, 23, 68, 0.2);
            border: 1px solid var(--danger);
        }

        .event-bull {
            background-color: rgba(0, 200, 83, 0.2);
            border: 1px solid var(--success);
        }

        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard, .game-area {
                grid-template-columns: 1fr;
            }
            
            .stock-item {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto;
            }
            
            .stock-header {
                display: none;
            }
            
            .stats {
                flex-direction: column;
            }
            
            .time-controls {
                flex-wrap: wrap;
            }
            
            .time-btn {
                flex: 1 0 45%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Volatility Stocks</h1>
            <p class="subtitle">High-Risk Market Simulation</p>
        </div>
    </header>

    <div class="container">
        <div id="event-banner" class="event-banner" style="display: none;"></div>
        
        <div class="dashboard">
            <div class="card">
                <h2>Your Portfolio</h2>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="cash-balance">$10,000.00</div>
                        <div class="stat-label">Cash Balance</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="portfolio-value">$0.00</div>
                        <div class="stat-label">Stock Value</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-value">$10,000.00</div>
                        <div class="stat-label">Net Worth</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <h2>Performance</h2>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="daily-change">+0.00%</div>
                        <div class="stat-label">Today's Change</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="overall-change">+0.00%</div>
                        <div class="stat-label">Total Return</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="day-count">Day 1</div>
                        <div class="stat-label">Game Day</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <h2>Market Indicators</h2>
                <div class="market-indicators">
                    <div class="indicator">
                        <div class="stat-label">Volatility</div>
                        <div class="stat-value" id="volatility-index">Medium</div>
                        <div class="progress-bar">
                            <div class="progress" id="volatility-progress" style="width: 50%;"></div>
                        </div>
                    </div>
                    <div class="indicator">
                        <div class="stat-label">Trend</div>
                        <div class="stat-value" id="market-trend">Neutral</div>
                        <div class="progress-bar">
                            <div class="progress" id="trend-progress" style="width: 50%;"></div>
                        </div>
                    </div>
                    <div class="indicator">
                        <div class="stat-label">Risk Level</div>
                        <div class="stat-value" id="risk-level">Medium</div>
                        <div class="progress-bar">
                            <div class="progress" id="risk-progress" style="width: 50%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="time-controls">
            <button class="time-btn active" data-speed="1">1x Speed</button>
            <button class="time-btn" data-speed="2">2x Speed</button>
            <button class="time-btn" data-speed="5">5x Speed</button>
            <button class="time-btn" data-speed="0">Pause</button>
            <button id="next-day-btn">Next Day ‚Üí</button>
        </div>

        <div class="game-area">
            <div class="card">
                <h2>Stock Market</h2>
                <div class="stocks-list">
                    <div class="stock-item stock-header">
                        <div>Symbol</div>
                        <div>Company</div>
                        <div>Price</div>
                        <div>Change</div>
                        <div>Actions</div>
                    </div>
                    <div id="stocks-container">
                        <!-- Stocks will be populated by JavaScript -->
                    </div>
                </div>

                <div class="portfolio">
                    <h2>Your Portfolio</h2>
                    <div class="portfolio-item stock-header">
                        <div>Symbol</div>
                        <div>Shares</div>
                        <div>Current Value</div>
                        <div>Actions</div>
                    </div>
                    <div id="portfolio-items">
                        <!-- Portfolio items will be added here dynamically -->
                    </div>
                </div>
                
                <div class="risk-warning">
                    <h3>‚ö†Ô∏è High Risk Warning</h3>
                    <p>This market simulation features extreme volatility. Stocks can plummet or spike suddenly based on random events. Invest carefully!</p>
                </div>
            </div>

            <div class="sidebar">
                <div class="card">
                    <h2>Market News <span id="news-badge" class="negative">‚óè Live</span></h2>
                    <div id="news-container">
                        <!-- News will be populated by JavaScript -->
                    </div>
                </div>

                <div class="card tip">
                    <h3>üí° Risk Management Tip</h3>
                    <p id="current-tip">In highly volatile markets, consider setting stop-loss orders to limit potential losses from sudden price drops.</p>
                </div>

                <div class="card">
                    <h2>Market Analysis</h2>
                    <div class="chart-container">
                        <canvas id="market-chart"></canvas>
                    </div>
                    <p id="analysis-text">Overall market trend visualization</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Trade Modal -->
    <div class="modal" id="trade-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Buy Stock</h2>
                <span class="close">&times;</span>
            </div>
            <div id="modal-body">
                <p>Stock: <span id="modal-stock-symbol"></span> - <span id="modal-stock-name"></span></p>
                <p>Current Price: $<span id="modal-stock-price"></span></p>
                <p>Your Cash: $<span id="modal-cash-balance"></span></p>
                
                <label for="shares-input">Number of Shares:</label>
                <input type="number" id="shares-input" min="1" value="1">
                
                <p>Total Cost: $<span id="modal-total-cost">0.00</span></p>
                
                <div class="chart-container">
                    <canvas id="modal-chart"></canvas>
                </div>
                
                <div id="risk-indicator">
                    <h3>Risk Assessment</h3>
                    <p id="risk-assessment">Calculating...</p>
                </div>
                
                <button id="modal-confirm-btn">Confirm Purchase</button>
            </div>
        </div>
    </div>

    <!-- Stock Info Modal -->
    <div class="modal" id="info-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="info-modal-title">Stock Information</h2>
                <span class="close">&times;</span>
            </div>
            <div>
                <div class="tabs">
                    <div class="tab active" data-tab="info">Info</div>
                    <div class="tab" data-tab="chart">Chart</div>
                    <div class="tab" data-tab="analysis">Analysis</div>
                    <div class="tab" data-tab="news">News</div>
                </div>
                
                <div class="tab-content active" id="info-tab">
                    <h3 id="info-stock-symbol"></h3>
                    <p id="info-stock-description"></p>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-label">Sector</div>
                            <div class="stat-value" id="info-stock-sector"></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Volatility</div>
                            <div class="stat-value" id="info-stock-volatility"></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Risk Level</div>
                            <div class="stat-value" id="info-stock-risk"></div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="chart-tab">
                    <div class="chart-container">
                        <canvas id="stock-chart"></canvas>
                    </div>
                </div>
                
                <div class="tab-content" id="analysis-tab">
                    <div class="chart-container">
                        <canvas id="detailed-chart"></canvas>
                    </div>
                    <div id="technical-analysis">
                        <h3>Technical Indicators</h3>
                        <div id="indicators-list"></div>
                    </div>
                </div>
                
                <div class="tab-content" id="news-tab">
                    <div id="stock-news">
                        <!-- News items will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game state with extreme volatility
        const gameState = {
            day: 1,
            cash: 10000,
            portfolioValue: 0,
            initialInvestment: 10000,
            stocks: [
                { 
                    symbol: "TECH", 
                    name: "Tech Innovators Inc", 
                    price: 100.00, 
                    previousPrice: 100.00,
                    baseVolatility: 0.06, 
                    currentVolatility: 0.06,
                    sector: "Technology",
                    marketCap: "450B",
                    trend: "neutral",
                    history: [],
                    news: [],
                    risk: "High"
                },
                { 
                    symbol: "GREEN", 
                    name: "Green Energy Solutions", 
                    price: 75.50, 
                    previousPrice: 75.50,
                    baseVolatility: 0.08, 
                    currentVolatility: 0.08,
                    sector: "Energy",
                    marketCap: "85B",
                    trend: "volatile",
                    history: [],
                    news: [],
                    risk: "Very High"
                },
                { 
                    symbol: "MEDI", 
                    name: "MediHealth Pharmaceuticals", 
                    price: 120.75, 
                    previousPrice: 120.75,
                    baseVolatility: 0.05, 
                    currentVolatility: 0.05,
                    sector: "Healthcare",
                    marketCap: "210B",
                    trend: "stable",
                    history: [],
                    news: [],
                    risk: "Medium"
                },
                { 
                    symbol: "AUTO", 
                    name: "AutoDrive Motors", 
                    price: 88.25, 
                    previousPrice: 88.25,
                    baseVolatility: 0.07, 
                    currentVolatility: 0.07,
                    sector: "Automotive",
                    marketCap: "75B",
                    trend: "bullish",
                    history: [],
                    news: [],
                    risk: "High"
                },
                { 
                    symbol: "RETL", 
                    name: "Retail Giants Corp", 
                    price: 65.80, 
                    previousPrice: 65.80,
                    baseVolatility: 0.09, 
                    currentVolatility: 0.09,
                    sector: "Retail",
                    marketCap: "120B",
                    trend: "bearish",
                    history: [],
                    news: [],
                    risk: "Very High"
                },
                { 
                    symbol: "BANK", 
                    name: "Global Bank Group", 
                    price: 42.30, 
                    previousPrice: 42.30,
                    baseVolatility: 0.05, 
                    currentVolatility: 0.05,
                    sector: "Financial",
                    marketCap: "180B",
                    trend: "stable",
                    history: [],
                    news: [],
                    risk: "Medium"
                },
                { 
                    symbol: "OIL", 
                    name: "PetroEnergy Ltd", 
                    price: 55.60, 
                    previousPrice: 55.60,
                    baseVolatility: 0.10, 
                    currentVolatility: 0.10,
                    sector: "Energy",
                    marketCap: "65B",
                    trend: "volatile",
                    history: [],
                    news: [],
                    risk: "Extreme"
                }
            ],
            portfolio: {},
            history: {},
            marketTrend: "neutral",
            economyState: "stable",
            volatility: 0.07,
            riskLevel: "Medium",
            news: [],
            timeSpeed: 1,
            timeInterval: null,
            marketHistory: [],
            eventActive: false,
            eventType: null,
            eventDuration: 0
        };

        // More comprehensive investment tips focused on risk
        const tips = [
            "In volatile markets, never invest more than you can afford to lose.",
            "Consider using stop-loss orders to automatically sell if a stock drops below a certain price.",
            "Diversification is even more important in high-risk markets.",
            "Avoid emotional trading - stick to your strategy even when markets are chaotic.",
            "High volatility means high potential returns but also high potential losses.",
            "Consider keeping a portion of your portfolio in cash to take advantage of market dips.",
            "Research shows that timing the market is extremely difficult, even for professionals.",
            "The biggest losses often come from panic selling during market crashes.",
            "Consider using limit orders instead of market orders to control your entry and exit points.",
            "In turbulent markets, assets can become correlated and all move down together.",
            "Be aware of confirmation bias - don't only seek information that supports your existing views.",
            "Document your trades and learn from both successes and failures."
        ];

        // Market news events that affect stock prices - with more extreme effects
        const newsEvents = [
            { text: "Federal Reserve emergency interest rate hike", impact: "market", effect: -0.15, type: "bear" },
            { text: "Tech sector crash amid valuation concerns", impact: "TECH", effect: -0.25, type: "bear" },
            { text: "Oil prices crash due to oversupply", impact: "OIL", effect: -0.35, type: "bear" },
            { text: "Banking crisis fears spread through market", impact: "BANK", effect: -0.20, type: "bear" },
            { text: "Retail bankruptcy wave announced", impact: "RETL", effect: -0.30, type: "bear" },
            { text: "Revolutionary battery technology announced", impact: ["TECH", "GREEN"], effect: 0.40, type: "bull" },
            { text: "FDA fast-tracks breakthrough drug", impact: "MEDI", effect: 0.50, type: "bull" },
            { text: "Autonomous vehicle regulations eased", impact: "AUTO", effect: 0.35, type: "bull" },
            { text: "Market circuit breakers triggered amid crash", impact: "market", effect: -0.20, type: "bear" },
            { text: "Economic stimulus package announced", impact: "market", effect: 0.18, type: "bull" },
            { text: "Company scandal: CEO resigns amid fraud allegations", impact: "random", effect: -0.45, type: "bear" },
            { text: "Short squeeze causes massive rally", impact: "random", effect: 0.60, type: "bull" },
            { text: "Cybersecurity breach affects millions", impact: "random", effect: -0.30, type: "bear" },
            { text: "Hostile takeover bid announced", impact: "random", effect: 0.40, type: "bull" }
        ];

        // Initialize the game
        function initGame() {
            // Initialize history for each stock
            gameState.stocks.forEach(stock => {
                gameState.history[stock.symbol] = [stock.price];
                // Generate more volatile history
                stock.history = Array(30).fill(null).map((_, i) => {
                    if (i === 0) return stock.price;
                    const change = (Math.random() * 0.1) - 0.05;
                    return Math.max(1, stock.history[i-1] * (1 + change));
                });
            });
            
            // Initialize market history
            gameState.marketHistory = Array(30).fill(100);
            
            // Generate initial news
            generateNews();
            
            // Render initial stocks
            renderStocks();
            
            // Create market chart
            createMarketChart();
            
            // Update UI
            updateUI();
            
            // Setup event listeners
            setupEventListeners();
            
            // Start the time progression
            setupTimeProgression();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Next day button
            document.getElementById('next-day-btn').addEventListener('click', nextDay);
            
            // Time speed buttons
            document.querySelectorAll('.time-btn[data-speed]').forEach(button => {
                button.addEventListener('click', function() {
                    const speed = parseInt(this.getAttribute('data-speed'));
                    setTimeSpeed(speed);
                });
            });
            
            // Close modals
            document.querySelectorAll('.close').forEach(close => {
                close.addEventListener('click', function() {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
            
            // Shares input
            document.getElementById('shares-input').addEventListener('input', function() {
                updateTotalCost();
                updateRiskAssessment();
            });
            
            // Confirm trade button
            document.getElementById('modal-confirm-btn').addEventListener('click', executeTrade);
            
            // Tab clicks
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
        }

        // Set up time progression
        function setupTimeProgression() {
            setTimeSpeed(1);
        }

        // Set the time speed
        function setTimeSpeed(speed) {
            gameState.timeSpeed = speed;
            
            // Update button states
            document.querySelectorAll('.time-btn[data-speed]').forEach(button => {
                if (parseInt(button.getAttribute('data-speed')) === speed) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            
            // Clear existing interval
            if (gameState.timeInterval) {
                clearInterval(gameState.timeInterval);
            }
            
            // Set new interval based on speed
            if (speed > 0) {
                gameState.timeInterval = setInterval(nextDay, 10000 / speed);
            }
        }

        // Move to the next day
        function nextDay() {
            gameState.day++;
            
            // Handle event duration
            if (gameState.eventActive) {
                gameState.eventDuration--;
                if (gameState.eventDuration <= 0) {
                    gameState.eventActive = false;
                    document.getElementById('event-banner').style.display = 'none';
                }
            } else if (Math.random() < 0.15) {
                // 15% chance of an event occurring
                triggerRandomEvent();
            }
            
            // Update market conditions
            updateMarketConditions();
            
            // Update stock prices with more realistic and volatile algorithm
            gameState.stocks.forEach(stock => {
                const previousPrice = stock.price;
                
                // Base random change based on volatility - much more volatile
                let changePercent = (Math.random() * 2 - 1) * stock.currentVolatility;
                
                // Apply market trend influence
                changePercent += (gameState.marketTrend === "bullish" ? 0.015 : -0.015);
                
                // Apply stock-specific trend
                if (stock.trend === "bullish") changePercent += 0.01;
                if (stock.trend === "bearish") changePercent -= 0.01;
                if (stock.trend === "volatile") changePercent *= 1.5;
                
                // Apply economic state influence
                changePercent += (gameState.economyState === "growing" ? 0.01 : -0.01);
                
                // Apply news impact if any
                const relevantNews = stock.news.filter(n => n.impact === stock.symbol || n.impact.includes(stock.symbol));
                relevantNews.forEach(news => {
                    changePercent += news.effect;
                });
                
                // Apply random market events (occasionally) - more severe
                if (Math.random() < 0.15) {
                    const eventSeverity = (Math.random() * 0.2) - 0.1;
                    changePercent += eventSeverity;
                }
                
                // Random sharp movements (crashes or spikes)
                if (Math.random() < 0.05) {
                    const sharpMove = Math.random() < 0.5 ? -0.25 : 0.25;
                    changePercent += sharpMove;
                }
                
                // Calculate new price with bounds checking
                stock.price = Math.max(0.01, stock.price * (1 + changePercent));
                stock.previousPrice = previousPrice;
                
                // Update history
                gameState.history[stock.symbol].push(stock.price);
                stock.history.push(stock.price);
                if (stock.history.length > 100) stock.history.shift();
                
                // Clear old news
                stock.news = [];
            });
            
            // Update market history
            const marketChange = calculateMarketChange();
            gameState.marketHistory.push(100 + marketChange);
            if (gameState.marketHistory.length > 50) gameState.marketHistory.shift();
            
            // Generate news
            if (Math.random() < 0.3) {
                generateNews();
            }
            
            // Update tip occasionally
            if (Math.random() < 0.2) {
                updateTip();
            }
            
            // Update UI
            updateUI();
            
            // Update market chart
            updateMarketChart();
        }

        // Trigger a random market event
        function triggerRandomEvent() {
            const event = newsEvents[Math.floor(Math.random() * newsEvents.length)];
            gameState.eventActive = true;
            gameState.eventType = event.type;
            gameState.eventDuration = 2 + Math.floor(Math.random() * 3); // 2-4 days
            
            // Apply the event effect
            if (event.impact === "market") {
                gameState.stocks.forEach(stock => {
                    stock.news.push(event);
                });
            } else if (event.impact === "random") {
                // Apply to a random stock
                const randomStock = gameState.stocks[Math.floor(Math.random() * gameState.stocks.length)];
                randomStock.news.push(event);
            } else if (Array.isArray(event.impact)) {
                event.impact.forEach(symbol => {
                    const stock = gameState.stocks.find(s => s.symbol === symbol);
                    if (stock) stock.news.push(event);
                });
            } else {
                const stock = gameState.stocks.find(s => s.symbol === event.impact);
                if (stock) stock.news.push(event);
            }
            
            // Show event banner
            const banner = document.getElementById('event-banner');
            banner.textContent = `MARKET EVENT: ${event.text}`;
            banner.className = `event-banner event-${event.type}`;
            banner.style.display = 'block';
            
            // Add to news
            gameState.news.unshift({
                text: event.text,
                impact: event.impact,
                effect: event.effect,
                time: `Day ${gameState.day}`,
                type: event.type
            });
            
            // Limit news to 10 items
            if (gameState.news.length > 10) {
                gameState.news.pop();
            }
            
            // Update news display
            renderNews();
        }

        // Update market conditions
        function updateMarketConditions() {
            // Randomly change market conditions more frequently
            if (Math.random() < 0.2) {
                const trends = ["bullish", "bearish", "neutral"];
                gameState.marketTrend = trends[Math.floor(Math.random() * trends.length)];
            }
            
            if (Math.random() < 0.2) {
                const economies = ["growing", "recession", "stable"];
                gameState.economyState = economies[Math.floor(Math.random() * economies.length)];
            }
            
            if (Math.random() < 0.25) {
                // More extreme volatility changes
                gameState.volatility = 0.05 + Math.random() * 0.15;
                
                // Update individual stock volatilities
                gameState.stocks.forEach(stock => {
                    stock.currentVolatility = stock.baseVolatility * (0.8 + Math.random() * 0.4);
                });
            }
            
            // Update risk level based on volatility
            if (gameState.volatility < 0.07) {
                gameState.riskLevel = "Low";
            } else if (gameState.volatility < 0.12) {
                gameState.riskLevel = "Medium";
            } else if (gameState.volatility < 0.18) {
                gameState.riskLevel = "High";
            } else {
                gameState.riskLevel = "Extreme";
            }
        }

        // Generate market news
        function generateNews() {
            const event = newsEvents[Math.floor(Math.random() * newsEvents.length)];
            const news = {
                text: event.text,
                impact: event.impact,
                effect: event.effect,
                time: `Day ${gameState.day}`,
                type: event.type
            };
            
            gameState.news.unshift(news);
            
            // Apply news effect to relevant stocks
            if (event.impact === "market") {
                gameState.stocks.forEach(stock => {
                    stock.news.push(news);
                });
            } else if (event.impact === "random") {
                // Apply to a random stock
                const randomStock = gameState.stocks[Math.floor(Math.random() * gameState.stocks.length)];
                randomStock.news.push(news);
            } else if (Array.isArray(event.impact)) {
                event.impact.forEach(symbol => {
                    const stock = gameState.stocks.find(s => s.symbol === symbol);
                    if (stock) stock.news.push(news);
                });
            } else {
                const stock = gameState.stocks.find(s => s.symbol === event.impact);
                if (stock) stock.news.push(news);
            }
            
            // Limit news to 10 items
            if (gameState.news.length > 10) {
                gameState.news.pop();
            }
            
            // Update news display
            renderNews();
        }

        // Render news items
        function renderNews() {
            const newsContainer = document.getElementById('news-container');
            newsContainer.innerHTML = '';
            
            gameState.news.forEach(news => {
                const newsItem = document.createElement('div');
                newsItem.className = 'news-item';
                newsItem.innerHTML = `
                    <div class="news-time">${news.time}</div>
                    <h3>${news.text}</h3>
                    <p>Market impact: ${news.effect > 0 ? 'Positive' : 'Negative'}</p>
                `;
                newsContainer.appendChild(newsItem);
            });
        }

        // Render stocks list
        function renderStocks() {
            const stocksContainer = document.getElementById('stocks-container');
            stocksContainer.innerHTML = '';
            
            gameState.stocks.forEach(stock => {
                const change = ((stock.price - stock.previousPrice) / stock.previousPrice * 100) || 0;
                
                const stockItem = document.createElement('div');
                stockItem.className = 'stock-item';
                
                // Add special class for large moves
                let changeClass = change >= 0 ? 'positive' : 'negative';
                if (Math.abs(change) > 10) {
                    changeClass = Math.abs(change) > 20 ? 'crash' : 'rally';
                }
                
                stockItem.innerHTML = `
                    <div class="stock-symbol">${stock.symbol}</div>
                    <div>${stock.name}</div>
                    <div class="stock-price">$${stock.price.toFixed(2)}</div>
                    <div class="stock-change ${changeClass}">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</div>
                    <div class="action-buttons">
                        <button class="btn-buy" data-symbol="${stock.symbol}">Buy</button>
                        <button class="btn-info" data-symbol="${stock.symbol}">Info</button>
                    </div>
                `;
                
                stockItem.querySelector('.btn-buy').addEventListener('click', function() {
                    openTradeModal(stock.symbol, 'buy');
                });
                
                stockItem.querySelector('.btn-info').addEventListener('click', function() {
                    openInfoModal(stock.symbol);
                });
                
                stocksContainer.appendChild(stockItem);
            });
        }

        // Update the UI with current game state
        function updateUI() {
            // Update day count
            document.getElementById('day-count').textContent = `Day ${gameState.day}`;
            
            // Update cash balance
            document.getElementById('cash-balance').textContent = `$${gameState.cash.toFixed(2)}`;
            
            // Update portfolio value
            let portfolioValue = 0;
            for (const symbol in gameState.portfolio) {
                const stock = gameState.stocks.find(s => s.symbol === symbol);
                portfolioValue += gameState.portfolio[symbol] * stock.price;
            }
            gameState.portfolioValue = portfolioValue;
            
            document.getElementById('portfolio-value').textContent = `$${portfolioValue.toFixed(2)}`;
            document.getElementById('total-value').textContent = `$${(gameState.cash + portfolioValue).toFixed(2)}`;
            
            // Calculate daily change
            const dailyReturn = calculateDailyReturn();
            const dailyChangeElement = document.getElementById('daily-change');
            dailyChangeElement.textContent = `${dailyReturn >= 0 ? '+' : ''}${dailyReturn.toFixed(2)}%`;
            dailyChangeElement.className = `stat-value ${dailyReturn >= 0 ? 'positive' : 'negative'}`;
            
            // Calculate overall change
            const overallReturn = ((gameState.cash + portfolioValue - gameState.initialInvestment) / gameState.initialInvestment * 100);
            const overallChangeElement = document.getElementById('overall-change');
            overallChangeElement.textContent = `${overallReturn >= 0 ? '+' : ''}${overallReturn.toFixed(2)}%`;
            overallChangeElement.className = `stat-value ${overallReturn >= 0 ? 'positive' : 'negative'}`;
            
            // Update market indicators
            document.getElementById('volatility-index').textContent = 
                gameState.volatility < 0.07 ? "Low" : gameState.volatility < 0.12 ? "Medium" : gameState.volatility < 0.18 ? "High" : "Extreme";
            document.getElementById('volatility-progress').style.width = `${gameState.volatility * 500}%`;
            document.getElementById('volatility-progress').className = `progress ${gameState.volatility < 0.07 ? 'positive' : gameState.volatility < 0.12 ? '' : 'negative'}`;
            
            document.getElementById('market-trend').textContent = gameState.marketTrend.charAt(0).toUpperCase() + gameState.marketTrend.slice(1);
            document.getElementById('trend-progress').style.width = gameState.marketTrend === "bullish" ? "70%" : gameState.marketTrend === "bearish" ? "30%" : "50%";
            document.getElementById('trend-progress').className = `progress ${gameState.marketTrend === "bullish" ? "positive" : gameState.marketTrend === "bearish" ? "negative" : ""}`;
            
            document.getElementById('risk-level').textContent = gameState.riskLevel;
            document.getElementById('risk-progress').style.width = 
                gameState.riskLevel === "Low" ? "25%" : 
                gameState.riskLevel === "Medium" ? "50%" : 
                gameState.riskLevel === "High" ? "75%" : "100%";
            document.getElementById('risk-progress').className = `progress ${gameState.riskLevel === "Low" ? "positive" : gameState.riskLevel === "Medium" ? "" : "negative"}`;
            
            // Update stock list
            renderStocks();
            
            // Update portfolio
            updatePortfolioDisplay();
        }

        // Calculate daily return
        function calculateDailyReturn() {
            let totalPrevValue = 0;
            let totalCurrentValue = 0;
            
            for (const symbol in gameState.portfolio) {
                const stock = gameState.stocks.find(s => s.symbol === symbol);
                totalPrevValue += gameState.portfolio[symbol] * stock.previousPrice;
                totalCurrentValue += gameState.portfolio[symbol] * stock.price;
            }
            
            if (totalPrevValue === 0) return 0;
            return (totalCurrentValue - totalPrevValue) / totalPrevValue * 100;
        }

        // Calculate overall market change
        function calculateMarketChange() {
            let totalChange = 0;
            gameState.stocks.forEach(stock => {
                if (gameState.history[stock.symbol].length > 1) {
                    const prevPrice = gameState.history[stock.symbol][gameState.history[stock.symbol].length - 2];
                    totalChange += (stock.price - prevPrice) / prevPrice * 100;
                }
            });
            return totalChange / gameState.stocks.length;
        }

        // Update portfolio display
        function updatePortfolioDisplay() {
            const portfolioItems = document.getElementById('portfolio-items');
            portfolioItems.innerHTML = '';
            
            for (const symbol in gameState.portfolio) {
                const shares = gameState.portfolio[symbol];
                const stock = gameState.stocks.find(s => s.symbol === symbol);
                const change = ((stock.price - stock.previousPrice) / stock.previousPrice * 100) || 0;
                
                const portfolioItem = document.createElement('div');
                portfolioItem.className = 'portfolio-item';
                portfolioItem.innerHTML = `
                    <div>${symbol}</div>
                    <div>${shares}</div>
                    <div>$${(shares * stock.price).toFixed(2)}</div>
                    <div>
                        <button class="btn-sell" data-symbol="${symbol}">Sell</button>
                    </div>
                `;
                
                portfolioItem.querySelector('.btn-sell').addEventListener('click', function() {
                    openTradeModal(symbol, 'sell');
                });
                
                portfolioItems.appendChild(portfolioItem);
            }
        }

        // Open trade modal
        function openTradeModal(symbol, type) {
            const modal = document.getElementById('trade-modal');
            const stock = gameState.stocks.find(s => s.symbol === symbol);
            
            document.getElementById('modal-title').textContent = type === 'buy' ? 'Buy Stock' : 'Sell Stock';
            document.getElementById('modal-stock-symbol').textContent = symbol;
            document.getElementById('modal-stock-name').textContent = stock.name;
            document.getElementById('modal-stock-price').textContent = stock.price.toFixed(2);
            document.getElementById('modal-cash-balance').textContent = gameState.cash.toFixed(2);
            document.getElementById('shares-input').value = '1';
            document.getElementById('modal-total-cost').textContent = (stock.price * 1).toFixed(2);
            
            document.getElementById('modal-confirm-btn').textContent = type === 'buy' ? 'Confirm Purchase' : 'Confirm Sale';
            document.getElementById('modal-confirm-btn').setAttribute('data-trade-type', type);
            document.getElementById('modal-confirm-btn').setAttribute('data-symbol', symbol);
            
            // Create chart in modal
            createModalChart(stock);
            
            // Update risk assessment
            updateRiskAssessment();
            
            modal.style.display = 'flex';
        }

        // Update risk assessment
        function updateRiskAssessment() {
            const symbol = document.getElementById('modal-confirm-btn').getAttribute('data-symbol');
            const type = document.getElementById('modal-confirm-btn').getAttribute('data-trade-type');
            const shares = parseInt(document.getElementById('shares-input').value) || 0;
            
            if (type === 'buy') {
                const stock = gameState.stocks.find(s => s.symbol === symbol);
                const investment = shares * stock.price;
                const portfolioPercent = investment / (gameState.cash + gameState.portfolioValue);
                
                let riskMessage = "";
                if (portfolioPercent > 0.2) {
                    riskMessage = `‚ö†Ô∏è High Risk: You're investing ${(portfolioPercent * 100).toFixed(1)}% of your portfolio in a single stock!`;
                } else if (portfolioPercent > 0.1) {
                    riskMessage = `‚ö†Ô∏è Medium Risk: You're investing ${(portfolioPercent * 100).toFixed(1)}% of your portfolio in this stock.`;
                } else {
                    riskMessage = `‚úÖ Low Risk: This investment represents ${(portfolioPercent * 100).toFixed(1)}% of your portfolio.`;
                }
                
                riskMessage += `<br>Stock volatility: ${(stock.currentVolatility * 100).toFixed(1)}%`;
                riskMessage += `<br>Overall market risk: ${gameState.riskLevel}`;
                
                document.getElementById('risk-assessment').innerHTML = riskMessage;
            } else {
                document.getElementById('risk-assessment').innerHTML = "Selling shares reduces your exposure to this stock's volatility.";
            }
        }

        // Create chart for modal
        function createModalChart(stock) {
            const ctx = document.getElementById('modal-chart').getContext('2d');
            
            // Use the last 20 data points for the chart
            const chartData = stock.history.slice(-20);
            const labels = chartData.map((_, i) => i + 1);
            
            if (window.modalChart) {
                window.modalChart.destroy();
            }
            
            window.modalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: stock.symbol,
                        data: chartData,
                        borderColor: '#2962ff',
                        backgroundColor: 'rgba(41, 98, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Recent Price History',
                            color: '#e5e7eb'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#e5e7eb'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#e5e7eb'
                            }
                        }
                    }
                }
            });
        }

        // Create market chart
        function createMarketChart() {
            const ctx = document.getElementById('market-chart').getContext('2d');
            
            const chartData = gameState.marketHistory;
            const labels = chartData.map((_, i) => i + 1);
            
            window.marketChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Market Index',
                        data: chartData,
                        borderColor: '#2962ff',
                        backgroundColor: 'rgba(41, 98, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Market Performance Index',
                            color: '#e5e7eb'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#e5e7eb'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#e5e7eb'
                            }
                        }
                    }
                }
            });
        }

        // Update market chart
        function updateMarketChart() {
            if (window.marketChart) {
                window.marketChart.data.labels = gameState.marketHistory.map((_, i) => i + 1);
                window.marketChart.data.datasets[0].data = gameState.marketHistory;
                window.marketChart.update();
            }
        }

        // Update total cost in trade modal
        function updateTotalCost() {
            const shares = parseInt(document.getElementById('shares-input').value) || 0;
            const price = parseFloat(document.getElementById('modal-stock-price').textContent);
            document.getElementById('modal-total-cost').textContent = (shares * price).toFixed(2);
        }

        // Execute trade
        function executeTrade() {
            const type = this.getAttribute('data-trade-type');
            const symbol = this.getAttribute('data-symbol');
            const shares = parseInt(document.getElementById('shares-input').value) || 0;
            const stock = gameState.stocks.find(s => s.symbol === symbol);
            const totalCost = shares * stock.price;
            
            if (type === 'buy') {
                if (totalCost > gameState.cash) {
                    alert("You don't have enough cash to make this purchase!");
                    return;
                }
                
                if (shares <= 0) {
                    alert("You must buy at least 1 share!");
                    return;
                }
                
                gameState.cash -= totalCost;
                gameState.portfolio[symbol] = (gameState.portfolio[symbol] || 0) + shares;
            } else {
                if (!gameState.portfolio[symbol] || shares > gameState.portfolio[symbol]) {
                    alert("You don't have enough shares to sell!");
                    return;
                }
                
                if (shares <= 0) {
                    alert("You must sell at least 1 share!");
                    return;
                }
                
                gameState.cash += totalCost;
                gameState.portfolio[symbol] -= shares;
                
                if (gameState.portfolio[symbol] === 0) {
                    delete gameState.portfolio[symbol];
                }
            }
            
            document.getElementById('trade-modal').style.display = 'none';
            updateUI();
        }

        // Open info modal
        function openInfoModal(symbol) {
            const modal = document.getElementById('info-modal');
            const stock = gameState.stocks.find(s => s.symbol === symbol);
            
            document.getElementById('info-modal-title').textContent = `${symbol} Information`;
            document.getElementById('info-stock-symbol').textContent = `${symbol} - ${stock.name}`;
            document.getElementById('info-stock-description').textContent = getStockDescription(symbol);
            document.getElementById('info-stock-sector').textContent = stock.sector;
            document.getElementById('info-stock-volatility').textContent = `${(stock.currentVolatility * 100).toFixed(1)}%`;
            document.getElementById('info-stock-risk').textContent = stock.risk;
            
            // Create charts
            createStockChart(stock);
            createDetailedChart(stock);
            
            // Load news
            loadStockNews(stock);
            
            // Load technical indicators
            loadTechnicalIndicators(stock);
            
            // Switch to info tab by default
            switchTab('info');
            
            modal.style.display = 'flex';
        }

        // Get stock description
        function getStockDescription(symbol) {
            const descriptions = {
                "TECH": "A leading technology company specializing in innovative software and hardware solutions. Known for its cutting-edge research and development in AI, cloud computing, and consumer electronics. HIGH VOLATILITY - Tech stocks can experience rapid price swings based on product announcements and market sentiment.",
                "GREEN": "A renewable energy company focused on solar and wind power solutions. Positioned for growth in the transition to clean energy with expanding operations in North America and Europe. VERY HIGH VOLATILITY - Energy stocks are sensitive to policy changes and commodity prices.",
                "MEDI": "A pharmaceutical company developing treatments for various medical conditions. Has a strong pipeline of new drugs in development and consistent revenue from established products. MEDIUM VOLATILITY - Healthcare stocks can be affected by regulatory decisions and clinical trial results.",
                "AUTO": "An automotive company pioneering electric and autonomous vehicles. Investing heavily in future mobility solutions with several new models scheduled for release next year. HIGH VOLATILITY - Auto stocks are cyclical and sensitive to economic conditions.",
                "RETL": "A large retail chain with stores across the country. Facing competition from online retailers but adapting with e-commerce initiatives and experiential retail locations. VERY HIGH VOLATILITY - Retail stocks can be highly sensitive to consumer spending trends.",
                "BANK": "A global financial services group offering banking, investment, and insurance products. Strong presence in consumer banking and corporate finance with international operations. MEDIUM VOLATILITY - Bank stocks are sensitive to interest rate changes and economic conditions.",
                "OIL": "An integrated energy company with operations in oil exploration, production, and refining. Facing transition challenges but maintaining strong cash flow from existing assets. EXTREME VOLATILITY - Oil stocks can experience wild swings based on geopolitical events and supply-demand dynamics."
            };
            
            return descriptions[symbol] || "No description available.";
        }

        // Create stock chart
        function createStockChart(stock) {
            const ctx = document.getElementById('stock-chart').getContext('2d');
            
            const chartData = stock.history;
            const labels = chartData.map((_, i) => i + 1);
            
            if (window.stockChart) {
                window.stockChart.destroy();
            }
            
            window.stockChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: stock.symbol,
                        data: chartData,
                        borderColor: '#2962ff',
                        backgroundColor: 'rgba(41, 98, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Price History',
                            color: '#e5e7eb'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#e5e7eb'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#e5e7eb'
                            }
                        }
                    }
                }
            });
        }

        // Create detailed chart with indicators
        function createDetailedChart(stock) {
            const ctx = document.getElementById('detailed-chart').getContext('2d');
            
            const chartData = stock.history;
            const labels = chartData.map((_, i) => i + 1);
            
            // Calculate simple moving average (SMA)
            const smaPeriod = 5;
            const sma = [];
            for (let i = 0; i < chartData.length; i++) {
                if (i < smaPeriod - 1) {
                    sma.push(null);
                } else {
                    let sum = 0;
                    for (let j = 0; j < smaPeriod; j++) {
                        sum += chartData[i - j];
                    }
                    sma.push(sum / smaPeriod);
                }
            }
            
            if (window.detailedChart) {
                window.detailedChart.destroy();
            }
            
            window.detailedChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Price',
                            data: chartData,
                            borderColor: '#2962ff',
                            backgroundColor: 'rgba(41, 98, 255, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: `SMA (${smaPeriod})`,
                            data: sma,
                            borderColor: '#ff1744',
                            borderWidth: 1,
                            pointRadius: 0,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Price with Moving Average',
                            color: '#e5e7eb'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#e5e7eb'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#e5e7eb'
                            }
                        }
                    }
                }
            });
        }

        // Load stock news
        function loadStockNews(stock) {
            const newsContainer = document.getElementById('stock-news');
            newsContainer.innerHTML = '';
            
            const relevantNews = gameState.news.filter(news => 
                news.impact === stock.symbol || 
                (Array.isArray(news.impact) && news.impact.includes(stock.symbol)) ||
                news.impact === 'market'
            );
            
            if (relevantNews.length === 0) {
                newsContainer.innerHTML = '<p>No recent news for this stock.</p>';
                return;
            }
            
            relevantNews.forEach(news => {
                const newsItem = document.createElement('div');
                newsItem.className = 'news-item';
                newsItem.innerHTML = `
                    <div class="news-time">${news.time}</div>
                    <h3>${news.text}</h3>
                    <p>Impact: ${news.effect > 0 ? 'Positive' : 'Negative'}</p>
                `;
                newsContainer.appendChild(newsItem);
            });
        }

        // Load technical indicators
        function loadTechnicalIndicators(stock) {
            const indicatorsContainer = document.getElementById('indicators-list');
            indicatorsContainer.innerHTML = '';
            
            // Calculate some basic indicators
            const prices = stock.history;
            const currentPrice = prices[prices.length - 1];
            const previousPrice = prices[prices.length - 2] || currentPrice;
            
            // Price change
            const priceChange = currentPrice - previousPrice;
            const priceChangePercent = (priceChange / previousPrice) * 100;
            
            // Volatility (standard deviation of last 10 prices)
            const recentPrices = prices.slice(-10);
            const avgPrice = recentPrices.reduce((a, b) => a + b, 0) / recentPrices.length;
            const volatility = Math.sqrt(recentPrices.map(p => Math.pow(p - avgPrice, 2)).reduce((a, b) => a + b, 0) / recentPrices.length);
            const volatilityPercent = (volatility / currentPrice) * 100;
            
            // Simple trend (comparing last 5 prices to previous 5)
            const last5 = prices.slice(-5);
            const prev5 = prices.slice(-10, -5);
            const avgLast5 = last5.reduce((a, b) => a + b, 0) / last5.length;
            const avgPrev5 = prev5.reduce((a, b) => a + b, 0) / prev5.length;
            const trend = avgLast5 > avgPrev5 ? "Upward" : avgLast5 < avgPrev5 ? "Downward" : "Sideways";
            
            // Risk assessment based on volatility
            let riskLevel;
            if (volatilityPercent < 5) riskLevel = "Low";
            else if (volatilityPercent < 10) riskLevel = "Medium";
            else if (volatilityPercent < 15) riskLevel = "High";
            else riskLevel = "Extreme";
            
            const indicators = [
                { name: "Current Price", value: `$${currentPrice.toFixed(2)}` },
                { name: "Daily Change", value: `${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)} (${priceChangePercent >= 0 ? '+' : ''}${priceChangePercent.toFixed(2)}%)`, 
                  type: priceChange >= 0 ? "positive" : "negative" },
                { name: "Volatility", value: volatilityPercent.toFixed(2) + "%" },
                { name: "Risk Level", value: riskLevel, 
                  type: riskLevel === "Low" ? "positive" : riskLevel === "Medium" ? "" : "negative" },
                { name: "Short-term Trend", value: trend, 
                  type: trend === "Upward" ? "positive" : trend === "Downward" ? "negative" : "" },
                { name: "Support Level", value: `$${(currentPrice * 0.85).toFixed(2)}` },
                { name: "Resistance Level", value: `$${(currentPrice * 1.15).toFixed(2)}` }
            ];
            
            indicators.forEach(indicator => {
                const indicatorElement = document.createElement('div');
                indicatorElement.className = 'stat-item';
                indicatorElement.innerHTML = `
                    <div class="stat-label">${indicator.name}</div>
                    <div class="stat-value ${indicator.type || ''}">${indicator.value}</div>
                `;
                indicatorsContainer.appendChild(indicatorElement);
            });
        }

        // Switch tabs in info modal
        function switchTab(tabName) {
            // Update tab visibility
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Update tip
        function updateTip() {
            document.getElementById('current-tip').textContent = tips[Math.floor(Math.random() * tips.length)];
        }

        // Initialize the game when the page loads
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
